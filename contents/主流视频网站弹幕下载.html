<!DOCTYPE html>
<html lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta name="google-site-verification" content="yHqnmkvA-12pculpP0D-q6lLqYStfJAnZCn5OLVFDfQ">
  <meta name="baidu-site-verification" content="VLW4ITHnBoryM4WZ">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lxmymjr.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="如今主流的视频网站（如 bilibili，腾讯，爱奇艺，优酷，芒果 TV 等）都支持了弹幕，本文介绍了如何下载视频弹幕（.xml）文件并转化为字幕（.ass）文件，支持本地播放。">
<meta property="og:type" content="article">
<meta property="og:title" content="主流视频网站弹幕下载">
<meta property="og:url" content="https://lxmymjr.github.io/contents/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD.html">
<meta property="og:site_name" content="xmliu&#39;s blog">
<meta property="og:description" content="如今主流的视频网站（如 bilibili，腾讯，爱奇艺，优酷，芒果 TV 等）都支持了弹幕，本文介绍了如何下载视频弹幕（.xml）文件并转化为字幕（.ass）文件，支持本地播放。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://lxmymjr.github.io/images/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD/Windows">
<meta property="article:published_time" content="2019-04-08T08:41:10.000Z">
<meta property="article:modified_time" content="2021-09-16T02:56:10.896Z">
<meta property="article:author" content="LIU, XIMING">
<meta property="article:tag" content="Tutorial">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Crawler">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lxmymjr.github.io/images/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD/Windows">


<link rel="canonical" href="https://lxmymjr.github.io/contents/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://lxmymjr.github.io/contents/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD.html","path":"contents/主流视频网站弹幕下载.html","title":"主流视频网站弹幕下载"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>主流视频网站弹幕下载 | xmliu's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">xmliu's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#xml%E6%A0%BC%E5%BC%8F%E5%BC%B9%E5%B9%95"><span class="nav-number">1.</span> <span class="nav-text">XML 格式弹幕</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%85%BE%E8%AE%AF%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD"><span class="nav-number">2.</span> <span class="nav-text">腾讯视频弹幕下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%88%B1%E5%A5%87%E8%89%BA%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD"><span class="nav-number">3.</span> <span class="nav-text">爱奇艺视频弹幕下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%98%E9%85%B7%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD"><span class="nav-number">4.</span> <span class="nav-text">优酷视频弹幕下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8A%92%E6%9E%9C%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD"><span class="nav-number">5.</span> <span class="nav-text">芒果视频弹幕下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD"><span class="nav-number">6.</span> <span class="nav-text">视频下载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%85%B3%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">6.1.</span> <span class="nav-text">下载相关安装包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8you-get"><span class="nav-number">6.2.</span> <span class="nav-text">使用 you-get</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%85%BE%E8%AE%AF%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD"><span class="nav-number">7.</span> <span class="nav-text">腾讯视频下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%BC%B9%E5%B9%95ass%E8%BD%AC%E6%8D%A2"><span class="nav-number">8.</span> <span class="nav-text">批量进行弹幕 ASS 转换</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="LIU, XIMING"
      src="/assets/avatar/yuntianhe.jpg">
  <p class="site-author-name" itemprop="name">LIU, XIMING</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lxmymjr?tab=repositories" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lxmymjr?tab&#x3D;repositories" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:xmliu.2015@smu.edu.sg" title="E-Mail → mailto:xmliu.2015@smu.edu.sg" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://sites.google.com/view/xmliu-smu/home" title="https:&#x2F;&#x2F;sites.google.com&#x2F;view&#x2F;xmliu-smu&#x2F;home" rel="noopener" target="_blank">Personal Homepage</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://lxmymjr.github.io/contents/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/avatar/yuntianhe.jpg">
      <meta itemprop="name" content="LIU, XIMING">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xmliu's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          主流视频网站弹幕下载<a href="https://github.com/lxmymjr/Blog/blob/master/source/_posts/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD.md" class="post-edit-link" title="Edit this post" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-08 16:41:10" itemprop="dateCreated datePublished" datetime="2019-04-08T16:41:10+08:00">2019-04-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-09-16 10:56:10" itemprop="dateModified" datetime="2021-09-16T10:56:10+08:00">2021-09-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>22k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>40 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>如今主流的视频网站（如 bilibili，腾讯，爱奇艺，优酷，芒果 TV 等）都支持了弹幕，本文介绍了如何下载视频弹幕（.xml）文件并转化为字幕（.ass）文件，支持本地播放。<br>
<span id="more"></span></p>
<h1 id="xml格式弹幕">XML 格式弹幕</h1>
<p>B 站是最早的一批弹幕网站之一，且比较成熟，弹幕可以直接以 XML 格式下载，非常方便，所以本文下载的弹幕均以 B 站的 XML 弹幕格式的简化为标准格式。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">d</span> <span class="attr">p</span>=<span class="string">"5,1,20,16777215"</span>&gt;</span>这是一条弹幕<span class="tag">&lt;/<span class="name">d</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>每一条弹幕的属性 p 的格式为：</p>
<ol type="1">
<li>弹幕发送时间，相对于视频开始时间，以秒为单位</li>
<li>弹幕类型，1-3 为滚动弹幕、4 为底部、5 为顶端、6 为逆向、7 为精确、8 为高级</li>
<li>字体大小，25 为中，18 为小，Bilibili 只有这 2 个字号，本地 20 字号比较合适（电脑分辨率是 1920*1080）</li>
<li>弹幕颜色，RGB 颜色转为十进制后的值，16777215 为白色</li>
<li>弹幕发送时间，Unix 时间戳格式</li>
<li>弹幕池，0 为普通，1 为字幕，2 为特殊</li>
<li>发送人的 id</li>
<li> 弹幕 id</li>
</ol>
<p>一般只需要使用前 4 项即可。</p>
<p>Python 中利用 request 库来爬取网页结果：<br>
</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_response</span>(<span class="params">url</span>):</span></span><br><span class="line">    req = urllib.request.Request(url)</span><br><span class="line">    req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36'</span>)</span><br><span class="line">    response = urllib.request.urlopen(req).read().decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>生成 XML 弹幕文件时需要检查是否有非法 XML 字符，并可以设置弹幕黑名单：<br>
</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">'XML/'</span> + title + <span class="string">'.xml'</span></span><br><span class="line">contents = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">    fout.write(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n'</span>)</span><br><span class="line">    fout.write(<span class="string">'&lt;i&gt;\n'</span>)</span><br><span class="line">    illegal = <span class="literal">False</span> <span class="comment">#标志是否有非法XML字符</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> [<span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'&amp;'</span>, <span class="string">'\u0000'</span>, <span class="string">'\b'</span>]:</span><br><span class="line">        <span class="keyword">if</span> char <span class="keyword">in</span> j[<span class="string">'content'</span>]:</span><br><span class="line">            illegal = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> illegal:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    black_list = [<span class="string">''</span>] <span class="comment">#列出弹幕黑名单</span></span><br><span class="line">    <span class="keyword">if</span> content <span class="keyword">not</span> <span class="keyword">in</span> contents <span class="keyword">and</span> <span class="built_in">all</span>(word <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">for</span> word <span class="keyword">in</span> black_list):</span><br><span class="line">        contents.append(content)</span><br><span class="line">        fout.write(<span class="string">'&lt;d p="'</span> + <span class="built_in">str</span>(timepoint) + <span class="string">','</span> + <span class="built_in">str</span>(ct) +<span class="string">','</span> + <span class="built_in">str</span>(size) + <span class="string">','</span> + <span class="built_in">str</span>(color) + <span class="string">'"&gt;'</span> + content + <span class="string">'&lt;/d&gt;\n'</span>)</span><br><span class="line">    fout.write(<span class="string">'&lt;/i&gt;'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>网上很多相关工具（如<a target="_blank" rel="noopener" href="https://tiansh.github.io/us-danmaku/bilibili/">弹幕 ASS 转换工具</a>等）可以将 XML 弹幕文件转换成 ASS 字幕文件。<br>
基于弹幕 ASS 转换工具个性化设置：<br>
</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置项，适合视频2倍速播放</span></span><br><span class="line"><span class="keyword">var</span> config = {</span><br><span class="line">  <span class="string">'playResX'</span>: <span class="number">1440</span>,          <span class="comment">// 屏幕分辨率宽（像素）</span></span><br><span class="line">  <span class="string">'playResY'</span>: <span class="number">810</span>,           <span class="comment">// 屏幕分辨率高（像素）</span></span><br><span class="line">  <span class="string">'fontlist'</span>: [              <span class="comment">// 字形（会自动选择最前面一个可用的）</span></span><br><span class="line">    <span class="string">'黑体'</span>,</span><br><span class="line">    <span class="string">'Microsoft YaHei UI'</span>,</span><br><span class="line">    <span class="string">'Microsoft YaHei'</span>,</span><br><span class="line">    <span class="string">'文泉驿正黑'</span>,</span><br><span class="line">    <span class="string">'STHeitiSC'</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">'font_size'</span>: <span class="number">1.2</span>,          <span class="comment">// 字号（比例）</span></span><br><span class="line">  <span class="string">'r2ltime'</span>: <span class="number">20</span>,             <span class="comment">// 右到左弹幕持续时间（秒）</span></span><br><span class="line">  <span class="string">'fixtime'</span>: <span class="number">5</span>,              <span class="comment">// 固定弹幕持续时间（秒）</span></span><br><span class="line">  <span class="string">'opacity'</span>: <span class="number">0.8</span>,            <span class="comment">// 不透明度（比例）</span></span><br><span class="line">  <span class="string">'space'</span>: <span class="number">0</span>,                <span class="comment">// 弹幕间隔的最小水平距离（像素）</span></span><br><span class="line">  <span class="string">'max_delay'</span>: <span class="number">6</span>,            <span class="comment">// 最多允许延迟几秒出现弹幕</span></span><br><span class="line">  <span class="string">'bottom'</span>: <span class="number">0</span>,               <span class="comment">// 底端给字幕保留的空间（像素）</span></span><br><span class="line">  <span class="string">'use_canvas'</span>: <span class="literal">true</span>,        <span class="comment">// 是否使用canvas计算文本宽度（布尔值，Linux下的火狐默认否，其他默认是，Firefox bug #561361）</span></span><br><span class="line">  <span class="string">'debug'</span>: <span class="literal">false</span>,            <span class="comment">// 打印调试信息</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="腾讯视频弹幕下载">腾讯视频弹幕下载</h1>
<p>打开一个腾讯视频 PC 网页端，其源码中的 VIDEO_INFO 字段：<br>
</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> VIDEO_INFO = {</span><br><span class="line">    <span class="string">"publish_date"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"leading_actor_id"</span>: [<span class="string">""</span>],</span><br><span class="line">    <span class="string">"duration"</span>: ,</span><br><span class="line">    <span class="string">"guests"</span>: ,</span><br><span class="line">    <span class="string">"race_teams_id"</span>: ,</span><br><span class="line">    <span class="string">"type_name"</span>: ,</span><br><span class="line">    <span class="string">"tag"</span>: [</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"singer_id"</span>: ,</span><br><span class="line">    <span class="string">"episode"</span>: ,</span><br><span class="line">    <span class="string">"race_stars_id"</span>: ,</span><br><span class="line">    <span class="string">"srcsite_name"</span>: ,</span><br><span class="line">    <span class="string">"type"</span>: ,</span><br><span class="line">    <span class="string">"title"</span>: ,</span><br><span class="line">    <span class="string">"leading_actor"</span>: [<span class="string">""</span>],</span><br><span class="line">    <span class="string">"show_type"</span>: ,</span><br><span class="line">    <span class="string">"singer_name"</span>: ,</span><br><span class="line">    <span class="string">"danmu_status"</span>: ,</span><br><span class="line">    <span class="string">"second_title"</span>: ,</span><br><span class="line">    <span class="string">"positive_trailer"</span>: ,</span><br><span class="line">    <span class="string">"athlete"</span>: ,</span><br><span class="line">    <span class="string">"mv_stars"</span>: ,</span><br><span class="line">    <span class="string">"trytime_second"</span>: ,</span><br><span class="line">    <span class="string">"c_full"</span>: ,</span><br><span class="line">    <span class="string">"update_flag"</span>: ,</span><br><span class="line">    <span class="string">"first_recommand"</span>: ,</span><br><span class="line">    <span class="string">"desc"</span>: ,</span><br><span class="line">    <span class="string">"pioneer_tag"</span>: ,</span><br><span class="line">    <span class="string">"begin_time"</span>: ,</span><br><span class="line">    <span class="string">"upload_qq"</span>: ,</span><br><span class="line">    <span class="string">"category_map"</span>: [, <span class="string">""</span>],</span><br><span class="line">    <span class="string">"is_trailer"</span>: ,</span><br><span class="line">    <span class="string">"stars_name"</span>: ,</span><br><span class="line">    <span class="string">"pic_640_360"</span>: ,</span><br><span class="line">    <span class="string">"c_title_segment"</span>: ,</span><br><span class="line">    <span class="string">"guests_id"</span>: ,</span><br><span class="line">    <span class="string">"presenter_id"</span>: ,</span><br><span class="line">    <span class="string">"upload_src"</span>: ,</span><br><span class="line">    <span class="string">"athlete_id"</span>: ,</span><br><span class="line">    <span class="string">"sec_recommand"</span>: ,</span><br><span class="line">    <span class="string">"costar_id"</span>: ,</span><br><span class="line">    <span class="string">"relative_stars_id"</span>: ,</span><br><span class="line">    <span class="string">"relative_stars"</span>: ,</span><br><span class="line">    <span class="string">"drm"</span>: ,</span><br><span class="line">    <span class="string">"modify_time"</span>: ,</span><br><span class="line">    <span class="string">"tail_time"</span>: ,</span><br><span class="line">    <span class="string">"valid_tag_id"</span>: ,</span><br><span class="line">    <span class="string">"vid"</span>: ,</span><br><span class="line">    <span class="string">"pic_url"</span>: ,</span><br><span class="line">    <span class="string">"costar"</span>: ,</span><br><span class="line">    <span class="string">"race_teams_name"</span>: ,</span><br><span class="line">    <span class="string">"c_title_output"</span>: ,</span><br><span class="line">    <span class="string">"director_id"</span>: [<span class="string">""</span>],</span><br><span class="line">    <span class="string">"title_en"</span>: ,</span><br><span class="line">    <span class="string">"stars"</span>: ,</span><br><span class="line">    <span class="string">"danmu"</span>: ,</span><br><span class="line">    <span class="string">"mv_stars_id"</span>: ,</span><br><span class="line">    <span class="string">"playright"</span>: [<span class="string">""</span>],</span><br><span class="line">    <span class="string">"presenter"</span>: ,</span><br><span class="line">    <span class="string">"race_stars"</span>: ,</span><br><span class="line">    <span class="string">"view_all_count"</span>: ,</span><br><span class="line">    <span class="string">"c_tags_flag"</span>: ,</span><br><span class="line">    <span class="string">"c_has_adv_danmu"</span>: ,</span><br><span class="line">    <span class="string">"head_time"</span>: ,</span><br><span class="line">    <span class="string">"state"</span>: ,</span><br><span class="line">    <span class="string">"copyright_id"</span>: ,</span><br><span class="line">    <span class="string">"pic160x90"</span>: ,</span><br><span class="line">    <span class="string">"director"</span>: [<span class="string">""</span>],</span><br><span class="line">    <span class="string">"famous_id"</span>: ,</span><br><span class="line">    <span class="string">"pioneer_tag_ids"</span>: ,</span><br><span class="line">    <span class="string">"trytime"</span>: ,</span><br><span class="line">    <span class="string">"famous_actor"</span>: ,</span><br><span class="line">    <span class="string">"video_checkup_time"</span>: ,</span><br><span class="line">    <span class="string">""</span>: ,</span><br><span class="line">    <span class="string">"isFull"</span>: </span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><br>
其中所需的字段是duration、title、vid。<br>
接下来通过vid找到targetid：<code>http://bullet.video.qq.com/fcgi-bin/target/regist?otype=json&amp;vid=(%vid%)</code>，打开此链接得到：<br>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">QZOutputJson = {</span><br><span class="line">    <span class="string">"danmukey"</span>:<span class="string">"bubble_flag=&amp;targetid=&amp;vid=&amp;type="</span>,</span><br><span class="line">    <span class="string">"display"</span>:,</span><br><span class="line">    <span class="string">"is_has_adv"</span>:,</span><br><span class="line">    <span class="string">"is_has_bubble"</span>:,</span><br><span class="line">    <span class="string">"open"</span>:,</span><br><span class="line">    <span class="string">"returncode"</span>:,</span><br><span class="line">    <span class="string">"returnmsg"</span>:,</span><br><span class="line">    <span class="string">"targetid"</span>:,</span><br><span class="line">    <span class="string">"userstatus"</span>:</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>
然后就可以通过targetid得到弹幕：<code>http://mfm.video.qq.com/danmu?timestamp=(%timestamp%)&amp;target_id=(%targetid%)</code>，其中timestamp从0开始并且以30为增量，打开此链接得到（只截取了第一条弹幕）：<br>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"err_code"</span>:,</span><br><span class="line">    <span class="attr">"err_msg"</span>:,</span><br><span class="line">    <span class="attr">"peroid"</span>:,</span><br><span class="line">    <span class="attr">"target_id"</span>:,</span><br><span class="line">    <span class="attr">"count"</span>:,</span><br><span class="line">    <span class="attr">"tol_up"</span>:,</span><br><span class="line">    <span class="attr">"single_max_count"</span>:,</span><br><span class="line">    <span class="attr">"session_key"</span>:,</span><br><span class="line">    <span class="attr">"comments"</span>:[</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">"commentid"</span>:,</span><br><span class="line">            <span class="attr">"content"</span>:,</span><br><span class="line">            <span class="attr">"upcount"</span>:,</span><br><span class="line">            <span class="attr">"isfriend"</span>:,</span><br><span class="line">            <span class="attr">"isop"</span>:,</span><br><span class="line">            <span class="attr">"isself"</span>:,</span><br><span class="line">            <span class="attr">"timepoint"</span>:,</span><br><span class="line">            <span class="attr">"headurl"</span>:,</span><br><span class="line">            <span class="attr">"opername"</span>:,</span><br><span class="line">            <span class="attr">"bb_bcolor"</span>:,</span><br><span class="line">            <span class="attr">"bb_head"</span>:,</span><br><span class="line">            <span class="attr">"bb_level"</span>:,</span><br><span class="line">            <span class="attr">"bb_id"</span>:,</span><br><span class="line">            <span class="attr">"rich_type"</span>:,</span><br><span class="line">            <span class="attr">"uservip_degree"</span>:,</span><br><span class="line">            <span class="attr">"content_style"</span>: <span class="string">"{\"color\":\"\",\"position\":}"</span></span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>
其中timepoint、content_style中的color、content字段可以组成xml弹幕格式。<br>
全部python代码为：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTMLText</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(url, timeout=<span class="number">30</span>)</span><br><span class="line">        r.raise_for_status()</span><br><span class="line">        r.encoding=<span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tencent_danmu</span>(<span class="params">url</span>):</span></span><br><span class="line">    video_info = json.loads(<span class="built_in">str</span>([s <span class="keyword">for</span> s <span class="keyword">in</span> getHTMLText(url).split(<span class="string">'\n'</span>) <span class="keyword">if</span> <span class="string">'VIDEO_INFO'</span> <span class="keyword">in</span> <span class="built_in">str</span>(s)]).strip(<span class="string">'[\'var VIDEO_INFO = '</span>).strip(<span class="string">'\']'</span>))</span><br><span class="line">    duration = video_info[<span class="string">'duration'</span>]</span><br><span class="line">    title = video_info[<span class="string">'title'</span>]</span><br><span class="line">    vid = video_info[<span class="string">'vid'</span>]</span><br><span class="line">    targetid = json.loads(getHTMLText(<span class="string">'http://bullet.video.qq.com/fcgi-bin/target/regist?otype=json&amp;vid='</span> + vid).strip(<span class="string">'QZOutputJson='</span>).strip(<span class="string">';'</span>))[<span class="string">'targetid'</span>]</span><br><span class="line">    filename = <span class="string">'XML/'</span> + title + <span class="string">'.xml'</span></span><br><span class="line">    contents = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\n'</span> + title + <span class="string">': '</span>, end=<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        fout.write(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;i&gt;\n'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(duration) // <span class="number">30</span> + <span class="number">1</span>):</span><br><span class="line">            timestamp = i*<span class="number">30</span></span><br><span class="line">            <span class="built_in">print</span>(i/<span class="number">2</span>, end=<span class="string">'min, '</span>)</span><br><span class="line">            response = getHTMLText(<span class="string">'http://mfm.video.qq.com/danmu?timestamp='</span> + <span class="built_in">str</span>(timestamp) + <span class="string">'&amp;target_id='</span> + targetid)</span><br><span class="line">            <span class="keyword">if</span> response == <span class="string">''</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                danmu = json.loads(response, strict=<span class="literal">False</span>)</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> danmu[<span class="string">'comments'</span>]:</span><br><span class="line">                    illegal = <span class="literal">False</span> <span class="comment">#标志是否有非法XML字符</span></span><br><span class="line">                    <span class="keyword">for</span> char <span class="keyword">in</span> [<span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'&amp;'</span>, <span class="string">'\u0000'</span>, <span class="string">'\b'</span>]:</span><br><span class="line">                        <span class="keyword">if</span> char <span class="keyword">in</span> j[<span class="string">'content'</span>]:</span><br><span class="line">                            illegal = <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> illegal:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    timepoint = j[<span class="string">'timepoint'</span>]  <span class="comment">#弹幕发送时间</span></span><br><span class="line">                    ct = <span class="number">1</span>              <span class="comment">#弹幕样式</span></span><br><span class="line">                    size = <span class="number">20</span>           <span class="comment">#字体大小</span></span><br><span class="line">                    <span class="comment"># 获取颜色</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">'color'</span> <span class="keyword">in</span> j[<span class="string">'content_style'</span>]:</span><br><span class="line">                        content_style = json.loads(j[<span class="string">'content_style'</span>])</span><br><span class="line">                        color = <span class="built_in">int</span>(content_style[<span class="string">'color'</span>], <span class="number">16</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        color = <span class="number">16777215</span></span><br><span class="line">                    content = j[<span class="string">'content'</span>] <span class="comment">#弹幕内容</span></span><br><span class="line">                    black_list = [<span class="string">'word'</span>]</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">':'</span> <span class="keyword">in</span> content:</span><br><span class="line">                        content = content.split(<span class="string">':'</span>)[<span class="number">1</span>].strip(<span class="string">'&nbsp;'</span>).strip(<span class="string">' '</span>)</span><br><span class="line">                    <span class="keyword">if</span> content <span class="keyword">not</span> <span class="keyword">in</span> contents <span class="keyword">and</span> <span class="built_in">all</span>(word <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">for</span> word <span class="keyword">in</span> black_list):</span><br><span class="line">                        contents.append(content.strip(<span class="string">' '</span>).strip(<span class="string">'&nbsp;'</span>))</span><br><span class="line">                        fout.write(<span class="string">'&lt;d p="'</span> + <span class="built_in">str</span>(timepoint) + <span class="string">','</span> + <span class="built_in">str</span>(ct) +<span class="string">','</span> + <span class="built_in">str</span>(size) + <span class="string">','</span> + <span class="built_in">str</span>(color) + <span class="string">'"&gt;'</span> + content + <span class="string">'&lt;/d&gt;\n'</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        fout.write(<span class="string">'&lt;/i&gt;'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="爱奇艺视频弹幕下载">爱奇艺视频弹幕下载</h1>
<p>打开一个爱奇艺视频 PC 网页端，其源码中的 page-info 字段：<br>
</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"albumId"</span>:,</span><br><span class="line">    <span class="attr">"albumName"</span>:,</span><br><span class="line">    <span class="attr">"imageUrl"</span>:,</span><br><span class="line">    <span class="attr">"tvId"</span>:,</span><br><span class="line">    <span class="attr">"vid"</span>:,</span><br><span class="line">    <span class="attr">"cid"</span>:,</span><br><span class="line">    <span class="attr">"isSource"</span>:,</span><br><span class="line">    <span class="attr">"contentType"</span>:,</span><br><span class="line">    <span class="attr">"vType"</span>:,</span><br><span class="line">    <span class="attr">"pType"</span>:,</span><br><span class="line">    <span class="attr">"pageNo"</span>:,</span><br><span class="line">    <span class="attr">"pageType"</span>:,</span><br><span class="line">    <span class="attr">"userId"</span>:,</span><br><span class="line">    <span class="attr">"pageUrl"</span>:,</span><br><span class="line">    <span class="attr">"tvName"</span>:,</span><br><span class="line">    <span class="attr">"isfeizhengpian"</span>:,</span><br><span class="line">    <span class="attr">"categoryName"</span>:,</span><br><span class="line">    <span class="attr">"categories"</span>:,</span><br><span class="line">    <span class="attr">"downloadAllowed"</span>:,</span><br><span class="line">    <span class="attr">"publicLevel"</span>:,</span><br><span class="line">    <span class="attr">"payMark"</span>:,</span><br><span class="line">    <span class="attr">"payMarkUrl"</span>:,</span><br><span class="line">    <span class="attr">"vipType"</span>:[</span><br><span class="line">        </span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"qiyiProduced"</span>:,</span><br><span class="line">    <span class="attr">"exclusive"</span>:,</span><br><span class="line">    <span class="attr">"tvYear"</span>:,</span><br><span class="line">    <span class="attr">"duration"</span>:<span class="string">"::"</span>,</span><br><span class="line">    <span class="attr">"wallId"</span>:,</span><br><span class="line">    <span class="attr">"rewardAllowed"</span>:,</span><br><span class="line">    <span class="attr">"commentAllowed"</span>:,</span><br><span class="line">    <span class="attr">"heatShowTypes"</span>:,</span><br><span class="line">    <span class="attr">"videoTemplate"</span>:,</span><br><span class="line">    <span class="attr">"issueTime"</span>:</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>
其中所需的字段是duration、tvName、albumId、tvId、cid。<br>
duration由‘时：分：秒’格式转为秒：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">duration_str = page_info[<span class="string">'duration'</span>].split(<span class="string">':'</span>)</span><br><span class="line">duration = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(duration_str)-<span class="number">1</span>):</span><br><span class="line">    duration = (duration + <span class="built_in">int</span>(duration_str[i])) * <span class="number">60</span></span><br><span class="line">duration = duration + <span class="built_in">int</span>(duration_str[-<span class="number">1</span>])</span><br></pre></td></tr></tbody></table></figure><br>
然后就可以通过albumId、tvId、cid得到弹幕：<code>http://cmts.iqiyi.com/bullet/(%tvId[-4:-2]%)/(%tvId[-2:]%)/(%tvId%)_300_(%page%).z?rn=0.(%16位随机数%)&amp;business=danmu&amp;is_iqiyi=true&amp;is_video_page=true&amp;tvid=(%tvid%)&amp;albumid=(%albumid%)&amp;categoryid=(%cid%)&amp;qypid=01010021010000000000</code>，其中tvId需要分割出倒数4-3位和倒数2-1位，page从1开始并且以1为增量，打开此链接得到(%tvId%)_300_(%page%).z的文件，这个文件是压缩的字节流需要解压。<br>
Python中利用zlib库，<code>dec = zlib.decompressobj(32 + zlib.MAX_WBITS)</code> 和 <code>b = dec.decompress('z文件').decode("utf-8")</code> 得到XML格式的弹幕（只截取了第一条弹幕）：<br>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">danmu</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">code</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">data</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">int</span>&gt;</span><span class="tag">&lt;/<span class="name">int</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">bulletInfo</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">contentId</span>&gt;</span><span class="tag">&lt;/<span class="name">contentId</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">content</span>&gt;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">showTime</span>&gt;</span>1<span class="tag">&lt;/<span class="name">showTime</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">font</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">color</span>&gt;</span><span class="tag">&lt;/<span class="name">color</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">opacity</span>&gt;</span><span class="tag">&lt;/<span class="name">opacity</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">position</span>&gt;</span><span class="tag">&lt;/<span class="name">position</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">background</span>&gt;</span><span class="tag">&lt;/<span class="name">background</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span><span class="tag">&lt;/<span class="name">contentType</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">isReply</span>&gt;</span><span class="tag">&lt;/<span class="name">isReply</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">likeCount</span>&gt;</span><span class="tag">&lt;/<span class="name">likeCount</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">plusCount</span>&gt;</span><span class="tag">&lt;/<span class="name">plusCount</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">dissCount</span>&gt;</span><span class="tag">&lt;/<span class="name">dissCount</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">userInfo</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">senderAvatar</span>&gt;</span><span class="tag">&lt;/<span class="name">senderAvatar</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">uid</span>&gt;</span><span class="tag">&lt;/<span class="name">uid</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">udid</span>&gt;</span><span class="tag">&lt;/<span class="name">udid</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;/<span class="name">userInfo</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">bulletInfo</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">data</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">sum</span>&gt;</span><span class="tag">&lt;/<span class="name">sum</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">validSum</span>&gt;</span><span class="tag">&lt;/<span class="name">validSum</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">duration</span>&gt;</span><span class="tag">&lt;/<span class="name">duration</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">ts</span>&gt;</span><span class="tag">&lt;/<span class="name">ts</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">danmu</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><br>
其中showTime、color、content字段可以组成xml弹幕格式（color需要从16进制转换成10进制）。<br>
全部python代码为：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTMLText</span>(<span class="params">url, encode</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(url, timeout=<span class="number">30</span>)</span><br><span class="line">        r.raise_for_status()</span><br><span class="line">        <span class="keyword">if</span> encode == <span class="string">'utf-8'</span>:</span><br><span class="line">            r.encoding=<span class="string">'utf-8'</span></span><br><span class="line">            <span class="keyword">return</span> r.text</span><br><span class="line">        <span class="keyword">elif</span> encode == <span class="string">'byte'</span>:</span><br><span class="line">            <span class="keyword">return</span> r.content</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_iqiyi_danmu</span>(<span class="params">url</span>):</span></span><br><span class="line">    page_info = json.loads(re.search(<span class="string">r'page-info=\'(.*)\'( *):video-info'</span>, getHTMLText(url, <span class="string">'utf-8'</span>)).group(<span class="number">1</span>))</span><br><span class="line">    duration_str = page_info[<span class="string">'duration'</span>].split(<span class="string">':'</span>)</span><br><span class="line">    duration = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(duration_str)-<span class="number">1</span>):</span><br><span class="line">        duration = (duration + <span class="built_in">int</span>(duration_str[i])) * <span class="number">60</span></span><br><span class="line">    duration = duration + <span class="built_in">int</span>(duration_str[-<span class="number">1</span>])</span><br><span class="line">    title = page_info[<span class="string">'tvName'</span>]</span><br><span class="line">    albumid = page_info[<span class="string">'albumId'</span>]</span><br><span class="line">    tvid = page_info[<span class="string">'tvId'</span>]</span><br><span class="line">    categoryid = page_info[<span class="string">'cid'</span>]</span><br><span class="line">    page = duration // (<span class="number">60</span> * <span class="number">5</span>) + <span class="number">1</span></span><br><span class="line">    filename = <span class="string">'XML/'</span> + title + <span class="string">'.xml'</span></span><br><span class="line">    contents = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        fout.write(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;i&gt;\n'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(duration // (<span class="number">60</span> * <span class="number">5</span>) + <span class="number">1</span>):</span><br><span class="line">            dec = zlib.decompressobj(<span class="number">32</span> + zlib.MAX_WBITS)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                b = dec.decompress(getHTMLText(<span class="string">'http://cmts.iqiyi.com/bullet/'</span> + <span class="built_in">str</span>(tvid)[-<span class="number">4</span>:-<span class="number">2</span>] + <span class="string">'/'</span> + <span class="built_in">str</span>(tvid)[-<span class="number">2</span>:] + <span class="string">'/'</span> + <span class="built_in">str</span>(tvid) + <span class="string">'_300_'</span> + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">'.z?rn=0.'</span> + <span class="string">''</span>.join([<span class="string">'%s'</span> % randint(<span class="number">0</span>, <span class="number">9</span>) <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>)]) + <span class="string">'&amp;business=danmu&amp;is_iqiyi=true&amp;is_video_page=true&amp;tvid='</span> + <span class="built_in">str</span>(tvid) + <span class="string">'&amp;albumid='</span> + <span class="built_in">str</span>(albumid) + <span class="string">'&amp;categoryid='</span> + <span class="built_in">str</span>(categoryid) + <span class="string">'&amp;qypid=01010021010000000000'</span>, <span class="string">'byte'</span>))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">'page: '</span> + <span class="built_in">str</span>(i))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">print</span>(<span class="string">'page not found: '</span> + <span class="built_in">str</span>(i)))</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                root = ET.fromstring(b.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(e)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> bulletInfo <span class="keyword">in</span> root.<span class="built_in">iter</span>(<span class="string">'bulletInfo'</span>):</span><br><span class="line">                timepoint = bulletInfo[<span class="number">3</span>].text      <span class="comment">#弹幕发送时间</span></span><br><span class="line">                ct = <span class="number">1</span>                              <span class="comment">#弹幕样式</span></span><br><span class="line">                size = <span class="number">20</span>                           <span class="comment">#字体大小</span></span><br><span class="line">                color = <span class="built_in">int</span>(bulletInfo[<span class="number">5</span>].text, <span class="number">16</span>) <span class="comment">#颜色</span></span><br><span class="line">                content = bulletInfo[<span class="number">1</span>].text        <span class="comment">#弹幕内容</span></span><br><span class="line">                black_list = [<span class="string">'word'</span>]</span><br><span class="line">                <span class="keyword">if</span> content <span class="keyword">not</span> <span class="keyword">in</span> contents <span class="keyword">and</span> <span class="built_in">all</span>(word <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">for</span> word <span class="keyword">in</span> black_list):</span><br><span class="line">                    contents.append(content)</span><br><span class="line">                    fout.write(<span class="string">'&lt;d p="'</span> + <span class="built_in">str</span>(timepoint) + <span class="string">','</span> + <span class="built_in">str</span>(ct) +<span class="string">','</span> + <span class="built_in">str</span>(size) + <span class="string">','</span> + <span class="built_in">str</span>(color) + <span class="string">'"&gt;'</span> + content + <span class="string">'&lt;/d&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;/i&gt;'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="优酷视频弹幕下载">优酷视频弹幕下载</h1>
<p>打开一个优酷视频 PC 网页端，其源码中的 window.PageConfig 字段：<br>
</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.PageConfig = {</span><br><span class="line">    <span class="attr">transfer_mode</span>: ,</span><br><span class="line">    isDRM: ,</span><br><span class="line">    videoCategoryId: ,</span><br><span class="line">    isSimple: ,</span><br><span class="line">    videoId: ,</span><br><span class="line">    newVersion: ,</span><br><span class="line">    isDebug: ,</span><br><span class="line">    pid: ,</span><br><span class="line">    homeHost: ,</span><br><span class="line">    youku_homeurl: ,</span><br><span class="line">    catId: ,</span><br><span class="line">    playmode: ,</span><br><span class="line">    videoOwner: ,</span><br><span class="line">    videoOwner_en: ,</span><br><span class="line">    videoId2: ,</span><br><span class="line">    currentEncodeVid: ,</span><br><span class="line">    catName: ,</span><br><span class="line">    seconds: ,</span><br><span class="line">    bullet: ,</span><br><span class="line">    transfer: ,</span><br><span class="line">    panorama: ,</span><br><span class="line">    folderId: ,</span><br><span class="line">    fpos: ,</span><br><span class="line">    forder: ,</span><br><span class="line">    ftotalpos: ,</span><br><span class="line">    showid_en: ,</span><br><span class="line">    showid: ,</span><br><span class="line">    cp: ,</span><br><span class="line">    paid: ,</span><br><span class="line">    showtype: ,</span><br><span class="line">    tabs: ,</span><br><span class="line">    singerId: ,</span><br><span class="line">    loadinglogo: ,</span><br><span class="line">    lottery_open_sidetool: ,</span><br><span class="line">    lottery_id_sidetool: ,</span><br><span class="line">    lottery_sidetool: ,</span><br><span class="line">    page: {</span><br><span class="line">        <span class="attr">type</span>: ,</span><br><span class="line">        isdatetype: ,</span><br><span class="line">        year: ,</span><br><span class="line">        firstMon: ,</span><br><span class="line">        lastMon: ,</span><br><span class="line">        currMon: ,</span><br><span class="line">        episodeLast: ,</span><br><span class="line">        parentvideoid: ,</span><br><span class="line">        compeleted:</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">copytoclip</span>: ,</span><br><span class="line">    playerUrl: </span><br><span class="line">};</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">"&amp;ct=c&amp;cs=&amp;td=&amp;s=&amp;v=&amp;u=&amp;paid=&amp;tt="</span>;</span><br></pre></td></tr></tbody></table></figure><br>
其中所需的字段是seconds、tt、videoId。<br>
然后就可以通过videoId得到弹幕：<code>https://service.danmu.youku.com/list?mat=(%mat%)&amp;ct=1001&amp;iid=(%videoId%)</code>，其中mat从0开始并且以1为增量，打开此链接得到（只截取了第一条弹幕）：<br>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"count"</span>: ,</span><br><span class="line">    <span class="attr">"filtered"</span>: ,</span><br><span class="line">    <span class="attr">"result"</span>: [{</span><br><span class="line">        <span class="attr">"aid"</span>: ,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"createtime"</span>: ,</span><br><span class="line">        <span class="attr">"ct"</span>: ,</span><br><span class="line">        <span class="attr">"extFields"</span>: {</span><br><span class="line">            <span class="attr">"voteUp"</span>: </span><br><span class="line">        },</span><br><span class="line">        <span class="attr">"id"</span>: ,</span><br><span class="line">        <span class="attr">"iid"</span>: ,</span><br><span class="line">        <span class="attr">"ipaddr"</span>: ,</span><br><span class="line">        <span class="attr">"level"</span>: ,</span><br><span class="line">        <span class="attr">"lid"</span>: ,</span><br><span class="line">        <span class="attr">"mat"</span>: ,</span><br><span class="line">        <span class="attr">"ouid"</span>: ,</span><br><span class="line">        <span class="attr">"playat"</span>: ,</span><br><span class="line">        <span class="attr">"propertis"</span>: <span class="string">"{\"pos\":,\"size\":,\"effect\":,\"color\":,\"dmfid\":}"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: ,</span><br><span class="line">        <span class="attr">"type"</span>: ,</span><br><span class="line">        <span class="attr">"uid"</span>: ,</span><br><span class="line">        <span class="attr">"ver"</span>: </span><br><span class="line">    }],</span><br><span class="line">    <span class="attr">"scm"</span>: <span class="string">"0"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>
其中playat、propertis中的color、content字段可以组成xml弹幕格式。<br>
全部python代码为：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_response</span>(<span class="params">url</span>):</span></span><br><span class="line">    req = urllib.request.Request(url)</span><br><span class="line">    req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36'</span>)</span><br><span class="line">    response = urllib.request.urlopen(req).read().decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_youku_danmu</span>(<span class="params">url</span>):</span></span><br><span class="line">    res = get_response(url)</span><br><span class="line">    title = re.search(<span class="string">r'&lt;title&gt;(.*)&lt;/title&gt;'</span>, res).group(<span class="number">1</span>).split(<span class="string">'—'</span>)[<span class="number">0</span>]</span><br><span class="line">    iid = re.search(<span class="string">r'videoId: \'(\d*)\''</span>, res).group(<span class="number">1</span>)</span><br><span class="line">    duration = <span class="built_in">float</span>(re.search(<span class="string">r'seconds: \'(.*)\','</span>, res).group(<span class="number">1</span>))</span><br><span class="line">    filename = <span class="string">'XML/'</span> + title.split(<span class="string">'集 '</span>)[<span class="number">0</span>] + <span class="string">'.xml'</span></span><br><span class="line">    contents = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        fout.write(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;i&gt;\n'</span>)</span><br><span class="line">        <span class="keyword">for</span> mat <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(duration) // <span class="number">60</span> + <span class="number">1</span>):</span><br><span class="line">            response = get_response(<span class="string">'https://service.danmu.youku.com/list?mat='</span> + <span class="built_in">str</span>(mat) + <span class="string">'&amp;ct=1001&amp;iid='</span> + iid)</span><br><span class="line">            danmu = json.loads(response)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(mat) + <span class="string">'\tresult:'</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(danmu[<span class="string">'result'</span>])))</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(danmu[<span class="string">'result'</span>])):</span><br><span class="line">                illegal = <span class="literal">False</span> <span class="comment">#标志是否有非法XML字符</span></span><br><span class="line">                <span class="keyword">for</span> char <span class="keyword">in</span> [<span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'&amp;'</span>, <span class="string">'\u0000'</span>, <span class="string">'\b'</span>]:</span><br><span class="line">                    <span class="keyword">if</span> char <span class="keyword">in</span> danmu[<span class="string">'result'</span>][i][<span class="string">'content'</span>]:</span><br><span class="line">                        illegal = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> illegal:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                playat = danmu[<span class="string">'result'</span>][i][<span class="string">'playat'</span>]/<span class="number">1000</span>  <span class="comment">#弹幕发送时间</span></span><br><span class="line">                ct = <span class="number">1</span>      <span class="comment">#弹幕样式</span></span><br><span class="line">                size = <span class="number">20</span>   <span class="comment">#字体大小</span></span><br><span class="line">                <span class="comment"># 获取颜色</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">'color'</span> <span class="keyword">in</span> danmu[<span class="string">'result'</span>][i][<span class="string">'propertis'</span>]:</span><br><span class="line">                    propertis = json.loads(danmu[<span class="string">'result'</span>][i][<span class="string">'propertis'</span>])</span><br><span class="line">                    color = propertis[<span class="string">'color'</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    color = <span class="number">16777215</span></span><br><span class="line">                content = danmu[<span class="string">'result'</span>][i][<span class="string">'content'</span>] <span class="comment">#弹幕内容</span></span><br><span class="line">                black_list = [<span class="string">'word'</span>]</span><br><span class="line">                <span class="keyword">if</span> content <span class="keyword">not</span> <span class="keyword">in</span> contents <span class="keyword">and</span> <span class="built_in">all</span>(word <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">for</span> word <span class="keyword">in</span> black_list):</span><br><span class="line">                	contents.append(content)</span><br><span class="line">                	fout.write(<span class="string">'&lt;d p="'</span> + <span class="built_in">str</span>(playat) + <span class="string">','</span> + <span class="built_in">str</span>(ct) +<span class="string">','</span> + <span class="built_in">str</span>(size) + <span class="string">','</span> + <span class="built_in">str</span>(color) + <span class="string">'"&gt;'</span> + content + <span class="string">'&lt;/d&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;/i&gt;'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="芒果视频弹幕下载">芒果视频弹幕下载</h1>
<p>打开一个芒果视频 PC 网页端，其网址（以 <code>https://www.mgtv.com/b/9015/4828668.html</code> 为例）中以 <code>/</code> 分割，倒数第二位是 cid，倒数第一位是 vid。<br>
从源码中 <code>&lt;title&gt;霸王别姬 - 视频在线观看 - 霸王别姬 - 芒果TV&lt;/title&gt;</code> 可获得 title。<br>
然后就可以通过 cid 和 vid 得到弹幕：<code>https://galaxy.bz.mgtv.com/rdbarrage?vid=(%vid%)&amp;cid=(%cid%)&amp;time=(%time%)</code>，其中 time 从 0 开始并且下一个 time 的值可从弹幕中得到，打开此链接得到（只截取了第一条弹幕）：<br>
</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"status"</span>:,</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"操作成功"</span>,</span><br><span class="line">    <span class="attr">"seq"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"data"</span>:{</span><br><span class="line">        <span class="attr">"next"</span>:,</span><br><span class="line">        <span class="attr">"interval"</span>:,</span><br><span class="line">        <span class="attr">"items"</span>:[</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">"id"</span>:,</span><br><span class="line">                <span class="attr">"type"</span>:,</span><br><span class="line">                <span class="attr">"uid"</span>:,</span><br><span class="line">                <span class="attr">"content"</span>:,</span><br><span class="line">                <span class="attr">"time"</span>:</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>
其中time、content字段可以组成xml弹幕格式。<br>
全部python代码为：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">sys.stdout = io.TextIOWrapper(sys.stdout.buffer,encoding=<span class="string">'utf8'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_response</span>(<span class="params">url</span>):</span></span><br><span class="line">    req = urllib.request.Request(url)</span><br><span class="line">    req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36'</span>)</span><br><span class="line">    response = urllib.request.urlopen(req).read().decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mangguo_danmu</span>(<span class="params">url</span>):</span></span><br><span class="line">    cid = url.split(<span class="string">'/'</span>)[<span class="number">4</span>]</span><br><span class="line">    vid = url.split(<span class="string">'/'</span>)[<span class="number">5</span>].strip(<span class="string">'.html'</span>)</span><br><span class="line">    video_info = json.loads(get_response(<span class="string">'https://pcweb.api.mgtv.com/video/info?vid=8244411&amp;cid=335811'</span>))</span><br><span class="line">    title = video_info[<span class="string">'data'</span>][<span class="string">'info'</span>][<span class="string">'videoName'</span>]</span><br><span class="line">    filename = <span class="string">'XML/'</span> + title + <span class="string">'.xml'</span></span><br><span class="line">    contents = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        fout.write(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;\n'</span>)</span><br><span class="line">        fout.write(<span class="string">'&lt;i&gt;\n'</span>)</span><br><span class="line">        time = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'https://galaxy.bz.mgtv.com/rdbarrage?version=2.0.0&amp;vid='</span> + vid + <span class="string">'&amp;cid='</span> + cid + <span class="string">'&amp;time='</span> + <span class="built_in">str</span>(time))</span><br><span class="line">            danmu = json.loads(get_response(<span class="string">'https://galaxy.bz.mgtv.com/rdbarrage?version=2.0.0&amp;vid='</span> + vid + <span class="string">'&amp;cid='</span> + cid + <span class="string">'&amp;time='</span> + <span class="built_in">str</span>(time)))</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(time))</span><br><span class="line">            <span class="keyword">if</span> danmu[<span class="string">'data'</span>][<span class="string">'items'</span>] == <span class="literal">None</span>:</span><br><span class="line">            	<span class="keyword">break</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> danmu[<span class="string">'data'</span>][<span class="string">'items'</span>]:</span><br><span class="line">                illegal = <span class="literal">False</span> <span class="comment">#标志是否有非法XML字符</span></span><br><span class="line">                <span class="keyword">for</span> char <span class="keyword">in</span> [<span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'&amp;'</span>, <span class="string">'\u0000'</span>, <span class="string">'\b'</span>]:</span><br><span class="line">                    <span class="keyword">if</span> char <span class="keyword">in</span> j[<span class="string">'content'</span>]:</span><br><span class="line">                        illegal = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> illegal:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                timepoint = j[<span class="string">'time'</span>]/<span class="number">1000</span>  <span class="comment">#弹幕发送时间</span></span><br><span class="line">                ct = <span class="number">1</span>                      <span class="comment">#弹幕样式</span></span><br><span class="line">                size = <span class="number">20</span>                   <span class="comment">#字体大小</span></span><br><span class="line">                color = <span class="number">16777215</span>            <span class="comment">#弹幕颜色</span></span><br><span class="line">                content = j[<span class="string">'content'</span>]         <span class="comment">#弹幕内容</span></span><br><span class="line">                black_list = [<span class="string">'word'</span>]</span><br><span class="line">                <span class="keyword">if</span> content <span class="keyword">not</span> <span class="keyword">in</span> contents <span class="keyword">and</span> <span class="built_in">all</span>(word <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">for</span> word <span class="keyword">in</span> black_list):</span><br><span class="line">                    contents.append(content)</span><br><span class="line">                    fout.write(<span class="string">'&lt;d p="'</span> + <span class="built_in">str</span>(timepoint) + <span class="string">','</span> + <span class="built_in">str</span>(ct) +<span class="string">','</span> + <span class="built_in">str</span>(size) + <span class="string">','</span> + <span class="built_in">str</span>(color) + <span class="string">'"&gt;'</span> + content + <span class="string">'&lt;/d&gt;\n'</span>)</span><br><span class="line">            time = danmu[<span class="string">'data'</span>][<span class="string">'next'</span>]</span><br><span class="line">        fout.write(<span class="string">'&lt;/i&gt;'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="视频下载">视频下载</h1>
<p><a target="_blank" rel="noopener" href="https://github.com/soimort/you-get">You-Get</a> 是一个命令行程序，提供便利的方式来下载网络上的媒体信息。<br>
you-get 的功用:<br>
1. 下载流行网站的音频、视频 (<a target="_blank" rel="noopener" href="https://github.com/soimort/you-get/wiki/中文说明#支持网站">查看完整支持列表</a>)<br>
2. 在媒体播放器中观看在线视频，脱离浏览器与广告<br>
3. 下载喜欢的网页上的图片<br>
4. 下载任何非 HTML 内容，例如二进制文件</p>
<p>you-get 主要在 linux 等开源平台上运行，由于家用电脑大多为 windows 系统，安装方法如下：</p>
<h2 id="下载相关安装包">下载相关安装包</h2>
<p>以下是必要依赖，需要单独安装，除非于 Windows 下使用预包装包:<br>
<a target="_blank" rel="noopener" href="https://www.python.org/downloads/">Python 3</a><br>
<a target="_blank" rel="noopener" href="https://www.ffmpeg.org/">FFmpeg</a> 或者 [Libav] https://libav.org/</p>
<ol type="1">
<li><p>通过 pip 安装<br>
you-get 的官方版本通过 <a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/you-get">PyPI</a> 分发，可从 PyPI 镜像中通过 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Pip_(package_manager)">pip</a> 包管理器安装。务必使用版本 3 的 pip:<br>
<code>$ pip3 install you-get</code></p></li>
<li><p>Git clone<br>
<code>$ git clone git://github.com/soimort/you-get.git</code><br>
将源码解压到任意目录即可</p></li>
</ol>
<p>升级<br>
考虑到 you-get 安装方法的差异，请使用:<br>
<code>$ pip3 install --upgrade you-get</code><br>
或下载最新更新:<br>
<code>$ you-get https://github.com/soimort/you-get/archive/master.zip</code></p>
<h2 id="使用you-get">使用 you-get</h2>
<p>进入解压文件夹 you-get-develop 下，在该目录下打开 Windows Powershell。<br>
<img src="/images/%E4%B8%BB%E6%B5%81%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD/Windows" class="" title="Powershell.png 710 330"><br>
输入 <code>python you-get 视频网址</code>即可使用下载功能（视频保存在 you-get-develop 目录下）。</p>
<h1 id="腾讯视频下载">腾讯视频下载</h1>
<p>打开腾讯视频播放页，打开控制台（F12），Network 选项下搜索 "ts.m3u8" 字段，找到类似下面的网址：<br>
<code>https://apd-(32位字符串).v.smtcdns.com/moviets.tc.qq.com/(44位字符串)/uwMROfz0r5xgoaQXGdGnC2df64hwtZlCglRDKOjEZ_qQW-eC/(160位字符串)/(vid).(数字).ts.m3u8?ver=4</code></p>
<p>此 m3u8 文件存有 ts 索引相对地址：<br>
</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:</span><br><span class="line">#EXT-X-TARGETDURATION:</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:</span><br><span class="line">#EXTINF:(时长),</span><br><span class="line">0(#)_(vid).(数字).(#).ts?index=(数字)&amp;start=(数字)&amp;end=(数字)&amp;brs=(数字)&amp;bre=(数字)&amp;ver=4</span><br></pre></td></tr></tbody></table></figure><br>
可以利用如下代码下载并且合并ts文件：<br>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_response</span>(<span class="params">url</span>):</span></span><br><span class="line">    req = urllib.request.Request(url)</span><br><span class="line">    req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36'</span>)</span><br><span class="line">    response = urllib.request.urlopen(req).read()</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">url_m3u8 = <span class="string">'(m3u8地址)'</span></span><br><span class="line">EXTM3U = get_response(url_m3u8).decode(<span class="string">'utf-8'</span>).split(<span class="string">'\n'</span>)</span><br><span class="line">ts = [i <span class="keyword">for</span> i <span class="keyword">in</span> EXTM3U <span class="keyword">if</span> <span class="string">'ts'</span> <span class="keyword">in</span> i]</span><br><span class="line">url_header = url_m3u8[::-<span class="number">1</span>].split(<span class="string">'/'</span>, <span class="number">1</span>)[<span class="number">1</span>][::-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ts:</span><br><span class="line">    url_ts = url_header + <span class="string">'/'</span> + i</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'(文件名).ts'</span>, <span class="string">'ab'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(get_response(url_ts))</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="批量进行弹幕ass转换">批量进行弹幕 ASS 转换</h1>
<p>安装 selenium<br>
pip install selenium</p>
<p>如果用 chrome<br>
查看 chrome 的版本号 (Chromium 72.0.3626.121)<br>
https://chromedriver.storage.googleapis.com/LATEST_RELEASE_72.0.3626<br>
https://chromedriver.storage.googleapis.com/index.html?path=72.0.3626.69/<br>
下载相应 win32 版本<br>
解压放入 python 根目录<br>
修改 common.js<br>
<code>startDownload('\ufeff' + ass, name.replace(/\.[^.]*$/, '') + '.ass');</code><br>
改为 <code>return ass;</code></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Tutorial/" rel="tag"># Tutorial</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/Crawler/" rel="tag"># Crawler</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/contents/Firebase%E5%AD%98%E5%82%A8%E6%95%99%E7%A8%8B.html" rel="prev" title="Firebase 存储教程">
                  <i class="fa fa-chevron-left"></i> Firebase 存储教程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/contents/%E8%A7%A3%E9%94%81%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%98%E7%81%B0%E6%AD%8C%E6%9B%B2.html" rel="next" title="解锁网易云音乐客户端变灰歌曲">
                  解锁网易云音乐客户端变灰歌曲 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIU, XIMING</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">192k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">5:49</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.2.6/pdfobject.min.js","integrity":"sha256-77geM50MfxCD17eqyJR+Dag1svjJOLN+BJ2F/DMqMEY="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



</body>
</html>
